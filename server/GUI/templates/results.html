<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LoRa Traffic Scenario Live Output</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="bg-light">

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
  <div class="container-fluid">
    <a class="navbar-brand" href="/">6G-LORE Testbed</a>
    <div class="d-flex ms-auto">
      {% if mode == 'lora' %}
        <a href="{{ dashboards.real_time['lora'] }}" class="btn btn-outline-info me-2" target="_blank"
          {% if node_name == "Node 3" %} style="display:none;" {% endif %}>
          ğŸ“ˆ Real-Time Measurements (LoRa)
        </a>
      {% elif mode == '5g' %}
        <a href="{{ dashboards.real_time['5g'] }}" class="btn btn-outline-info me-2" target="_blank">
          ğŸ“ˆ Real-Time Measurements (5G)
        </a>
      {% else %}
        <a href="#" class="btn btn-outline-secondary me-2 disabled" tabindex="-1" aria-disabled="true">
          No Real-Time Dashboard
        </a>
      {% endif %}
      <a href="{{ url_for('logout') }}" class="btn btn-danger fw-bold text-white">Logout</a>
    </div>
  </div>
</nav>

<div class="container py-5">
  <h1 class="mb-4 text-center text-success">Live Execution Output - {{ node_name }}</h1>

  <div class="card mx-auto" style="max-width: 700px;">
    <div class="card-body">
      <p><strong>Parameters:</strong> r={{ r }}, s={{ s }}, d={{ d }}, p={{ p }}, mode={{ mode|capitalize }}</p>

      <pre id="output" class="bg-white p-3 border rounded" style="height: 300px; overflow-y: auto;"></pre>

      <div class="d-flex justify-content-center gap-3 mt-3">
        <button id="abort-btn" class="btn btn-danger">Abort</button>
        <a href="/" class="btn btn-secondary">Run New Scenario</a>
      </div>

      <div id="grafana-link" class="mt-3 text-center" style="display:none;">
        {% if mode == 'lora' %}
          <a href="{{ dashboards.real_time['lora'] }}" target="_blank" class="btn btn-outline-info me-2"
            {% if node_name == "Node 3" %} style="display:none;" {% endif %}>
            ğŸ“ˆ Real-Time Measurements (LoRa)
          </a>
          <a href="{{ dashboards['lora'] }}" target="_blank" class="btn btn-outline-primary">
            ğŸ” LoRa Dashboard
          </a>
        {% elif mode == '5g' %}
          <a href="{{ dashboards.real_time['5g'] }}" target="_blank" class="btn btn-outline-info me-2">
            ğŸ“ˆ Real-Time Measurements (5G)
          </a>
          <a href="{{ dashboards['5g'] }}" target="_blank" class="btn btn-outline-primary">
            ğŸ” 5G Dashboard
          </a>
        {% else %}
          <a href="#" class="btn btn-outline-secondary me-2 disabled" tabindex="-1" aria-disabled="true">
            No Real-Time Dashboard
          </a>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<script>
  const output = document.getElementById("output");
  const abortBtn = document.getElementById("abort-btn");

  const node = "{{ node_ip }}";
  const r = "{{ r }}";
  const s = "{{ s }}";
  const d = "{{ d }}";
  const p = "{{ p }}";
  const mode = "{{ mode }}";

  const evtSource = new EventSource(`/stream?node=${encodeURIComponent(node)}&r=${encodeURIComponent(r)}&s=${encodeURIComponent(s)}&d=${encodeURIComponent(d)}&p=${encodeURIComponent(p)}&mode=${encodeURIComponent(mode)}`);

  evtSource.onmessage = function(event) {
    if (event.data === "__end__") {
      evtSource.close();
      document.getElementById("grafana-link").style.display = "block";
      abortBtn.disabled = true;
      abortBtn.textContent = "Completed";
    } else {
      output.textContent += event.data + "\n";
      output.scrollTop = output.scrollHeight;
    }
  };

  evtSource.onerror = function() {
    output.textContent += "\n--- Connection lost ---\n";
    evtSource.close();
    document.getElementById("grafana-link").style.display = "block";
    abortBtn.disabled = true;
    abortBtn.textContent = "Connection lost";
  };

  abortBtn.onclick = function() {
    if (!confirm("Abort the running script?")) return;

    abortBtn.disabled = true;
    abortBtn.textContent = "Aborting...";

    fetch('/abort', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ node: node })
    })
    .then(response => response.json())
    .then(data => {
      alert(data.message);
      if (data.status === "success") {
        evtSource.close();
        abortBtn.textContent = "Aborted";
      } else {
        abortBtn.disabled = false;
        abortBtn.textContent = "Abort";
      }
    })
    .catch(() => {
      alert("Abort request failed.");
      abortBtn.disabled = false;
      abortBtn.textContent = "Abort";
    });
  };
</script>

<footer class="text-center mt-5 mb-3 text-muted">
  <img src="{{ url_for('static', filename='image.png') }}" alt="Logo" style="max-height: 50px; margin-bottom: 10px;" />
  <div>Â© 2025 6G-LORE Testbed. All rights reserved.</div>
</footer>

</body>
</html>

